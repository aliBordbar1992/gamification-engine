### Gamification Engine API Tests
### This file contains HTTP requests for testing the API endpoints

### Test Environment Variables
@baseUrl = https://localhost:7001
@apiVersion = v1
@contentType = application/json

### 1. Event Ingestion Tests

#### Ingest a simple user comment event
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventId": "test-comment-1",
  "eventType": "USER_COMMENTED",
  "userId": "user-123",
  "occurredAt": "2024-01-15T10:30:00Z",
  "attributes": {
    "commentId": "comment-456",
    "postId": "post-789",
    "text": "Great post!"
  }
}

#### Ingest an event without eventId (should generate one)
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "PROFILE_COMPLETED",
  "userId": "user-456",
  "attributes": {
    "completenessPercent": 95.0
  }
}

#### Ingest an event without occurredAt (should use current time)
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "USER_PURCHASED_PRODUCT",
  "userId": "user-789",
  "attributes": {
    "productId": "prod-123",
    "amount": 29.99
  }
}

#### Ingest an event with complex attributes
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventId": "complex-event-1",
  "eventType": "USER_PURCHASED_PRODUCT",
  "userId": "complex-user-123",
  "occurredAt": "2024-01-15T10:30:00Z",
  "attributes": {
    "productId": "prod-456",
    "amount": 99.99,
    "currency": "USD",
    "tags": ["electronics", "gaming"],
    "metadata": {
      "source": "recommendation_engine",
      "confidence": 0.95
    },
    "isFirstPurchase": true,
    "discountApplied": 15.0
  }
}

#### Test validation - missing required fields
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventId": "invalid-event-1"
}

#### Test validation - empty event type
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "",
  "userId": "user-123"
}

#### Test validation - empty user ID
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "TEST_EVENT",
  "userId": ""
}

### 2. Event Retrieval Tests

#### Get events for a specific user
GET {{baseUrl}}/api/events/user/user-123

#### Get events for a specific user with pagination
GET {{baseUrl}}/api/events/user/user-123?limit=5&offset=0

#### Get events by type
GET {{baseUrl}}/api/events/type/USER_COMMENTED

#### Get events by type with pagination
GET {{baseUrl}}/api/events/type/USER_COMMENTED?limit=10&offset=5

#### Get a specific event by ID (valid event)
GET {{baseUrl}}/api/events/test-comment-1

#### Get a specific event by ID (non-existent event)
GET {{baseUrl}}/api/events/non-existent-event-id-12345

#### Get a specific event by ID (empty event ID - should return 400)
GET {{baseUrl}}/api/events/

### 2.1. Sandbox Dry-Run Tests

#### Dry-run evaluation with valid event
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventId": "dry-run-test-1",
  "eventType": "USER_COMMENTED",
  "userId": "user-123",
  "occurredAt": "2024-01-15T10:30:00Z",
  "attributes": {
    "commentId": "comment-456",
    "postId": "post-789",
    "text": "Great post!"
  }
}

#### Dry-run evaluation without eventId (should generate one)
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventType": "PROFILE_COMPLETED",
  "userId": "user-456",
  "attributes": {
    "completenessPercent": 95.0
  }
}

#### Dry-run evaluation without occurredAt (should use current time)
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventType": "USER_PURCHASED_PRODUCT",
  "userId": "user-789",
  "attributes": {
    "productId": "prod-123",
    "amount": 29.99
  }
}

#### Dry-run evaluation with complex attributes
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventId": "dry-run-complex-1",
  "eventType": "USER_PURCHASED_PRODUCT",
  "userId": "complex-user-123",
  "occurredAt": "2024-01-15T10:30:00Z",
  "attributes": {
    "productId": "prod-456",
    "amount": 99.99,
    "currency": "USD",
    "tags": ["electronics", "gaming"],
    "metadata": {
      "source": "recommendation_engine",
      "confidence": 0.95
    },
    "isFirstPurchase": true,
    "discountApplied": 15.0
  }
}

#### Dry-run evaluation test validation - missing required fields
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventId": "dry-run-invalid-1"
}

#### Dry-run evaluation test validation - empty event type
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventType": "",
  "userId": "user-123"
}

#### Dry-run evaluation test validation - empty user ID
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventType": "TEST_EVENT",
  "userId": ""
}

#### Dry-run evaluation with malformed JSON
POST {{baseUrl}}/api/events/sandbox/dry-run
Content-Type: {{contentType}}

{
  "eventType": "USER_COMMENTED",
  "userId": "user-123",
}

### 3. Error Handling Tests

#### Test invalid user ID (empty string)
GET {{baseUrl}}/api/events/user/

#### Test invalid event type (empty string)
GET {{baseUrl}}/api/events/type/

#### Test non-existent event ID
GET {{baseUrl}}/api/events/non-existent-id

### 4. Performance Tests

#### Test with large number of events
GET {{baseUrl}}/api/events/user/user-123?limit=1000&offset=0

#### Test with maximum pagination
GET {{baseUrl}}/api/events/type/USER_COMMENTED?limit=1000&offset=999

### 5. Edge Cases

#### Test with very long event type
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "VERY_LONG_EVENT_TYPE_NAME_THAT_MIGHT_CAUSE_ISSUES_WITH_VALIDATION_OR_DATABASE_STORAGE",
  "userId": "user-edge-1"
}

#### Test with very long user ID
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "TEST_EVENT",
  "userId": "very-long-user-id-that-might-cause-issues-with-validation-or-database-storage-123456789012345678901234567890"
}

#### Test with special characters in attributes
POST {{baseUrl}}/api/events
Content-Type: {{contentType}}

{
  "eventType": "SPECIAL_CHARS_TEST",
  "userId": "user-special-1",
  "attributes": {
    "text": "Special chars: !@#$%^&*()_+-=[]{}|;':\",./<>?",
    "unicode": "Unicode: ðŸš€ðŸŽ‰ðŸ’¯",
    "html": "<script>alert('test')</script>",
    "json": "{\"nested\": \"value\"}"
  }
}

### 6. Bulk Operations (Future Enhancement)
# These endpoints don't exist yet but could be useful for performance testing

#### Bulk event ingestion (future)
# POST {{baseUrl}}/api/events/bulk
# Content-Type: {{contentType}}
# 
# [
#   {
#     "eventType": "USER_COMMENTED",
#     "userId": "user-1",
#     "attributes": {"commentId": "comment-1"}
#   },
#   {
#     "eventType": "USER_COMMENTED",
#     "userId": "user-2",
#     "attributes": {"commentId": "comment-2"}
#   }
# ]

### 7. Health Check (Future Enhancement)
# GET {{baseUrl}}/health

### 8. Event Definitions CRUD Tests

#### Get all event definitions
GET {{baseUrl}}/api/EventDefinition

#### Get a specific event definition by ID
GET {{baseUrl}}/api/EventDefinition/USER_COMMENTED

#### Get a non-existent event definition
GET {{baseUrl}}/api/EventDefinition/NON_EXISTENT_EVENT_TYPE

#### Create a new event definition
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "USER_LIKED_POST",
  "description": "User liked a post",
  "payloadSchema": {
    "postId": "string",
    "likedBy": "string",
    "timestamp": "string"
  }
}

#### Create an event definition with minimal data
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "SIMPLE_EVENT",
  "description": "A simple event with no payload schema"
}

#### Create an event definition with complex payload schema
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "COMPLEX_EVENT",
  "description": "A complex event with detailed payload schema",
  "payloadSchema": {
    "userId": "string",
    "action": "string",
    "metadata": "object",
    "timestamp": "string",
    "version": "number"
  }
}

#### Try to create duplicate event definition (should return 409)
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "USER_COMMENTED",
  "description": "Duplicate event definition"
}

#### Update an existing event definition
PUT {{baseUrl}}/api/EventDefinition/USER_LIKED_POST
Content-Type: {{contentType}}

{
  "description": "Updated: User liked a post",
  "payloadSchema": {
    "postId": "string",
    "likedBy": "string",
    "timestamp": "string",
    "reactionType": "string"
  }
}

#### Update event definition with minimal data
PUT {{baseUrl}}/api/EventDefinition/SIMPLE_EVENT
Content-Type: {{contentType}}

{
  "description": "Updated simple event description"
}

#### Try to update non-existent event definition
PUT {{baseUrl}}/api/EventDefinition/NON_EXISTENT_EVENT_TYPE
Content-Type: {{contentType}}

{
  "description": "This should fail"
}

#### Delete an event definition
DELETE {{baseUrl}}/api/EventDefinition/USER_LIKED_POST

#### Try to delete non-existent event definition
DELETE {{baseUrl}}/api/EventDefinition/NON_EXISTENT_EVENT_TYPE

#### Test validation - create event definition with empty ID
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "",
  "description": "Invalid event definition"
}

#### Test validation - create event definition with empty description
POST {{baseUrl}}/api/EventDefinition
Content-Type: {{contentType}}

{
  "id": "VALID_ID",
  "description": ""
}

#### Test validation - update event definition with empty description
PUT {{baseUrl}}/api/EventDefinition/SIMPLE_EVENT
Content-Type: {{contentType}}

{
  "description": ""
}

### 9. Metrics (Future Enhancement)
# GET {{baseUrl}}/metrics

### Notes for Testing:
# 1. Make sure the API is running before executing these tests
# 2. Some endpoints may return different status codes based on implementation
# 3. The baseUrl should be updated to match your local development environment
# 4. Consider using environment variables for different test environments
# 5. These tests can be run in VS Code with the REST Client extension
# 6. For automated testing, consider using tools like Newman or similar HTTP testing tools
